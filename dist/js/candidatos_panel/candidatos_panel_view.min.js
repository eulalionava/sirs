var CandidatosPanel_view = Backbone.View.extend({
    el: 'body',
    defaults: {
        /*Información general*/
        nombres: "#nombres", apellido_paterno: "#apellido_paterno", apellido_materno: "#apellido_materno", 
        rfc: "#rfc", numero_telefono: "#numero_telefono", cargar_solicitud: "#cargar_solicitud"        
    }
    ,events:{
        "click .tab_control": "f_cambioTabs",
        "click .btnAvanzarProceso": "f_avanzarProceso",
        "click .btnFinalizarProceso": "f_finalizarProcesoSolicitud",
        "keydown .form_control_typing": "f_controlTypingTex",
        "select .form_control_typing": "f_selectTypingTex",
    },
    initialize: function(e){        
        try {
            var _this = this;
            _this.f_initializeListenerAudio();
            $(".form_control_typing").bind("cut copy paste",function(e) {
                e.preventDefault();
             });
             
        }catch(exception){
            console.log(exception);
        }
    },
    f_selectTypingTex: function(e){
        var _this = this;
        lo_currentAudio = e.currentTarget;
        li_id_pregunta = $(lo_currentAudio).data("iq");
        
        setTimeout(function() {
            $("textarea[data-iq='"+li_id_pregunta+"']").focus();
            console.log("focus");
        },10);
    },
    f_controlTypingTex: function(e){
        var _this = this;
        if(e.keyCode == 8 || e.keyCode == 37 || e.keyCode == 39){            
            return false;
        }
    },
    f_initializeListenerAudio: function(e){
        var _this = this;
        var audioTyping = document.getElementsByClassName("audio_typing");
        li_totalAudios = audioTyping.length;
        
        if(li_totalAudios > 0){
            for(li_index = 0; li_index < li_totalAudios; li_index++){
                audioTyping[li_index].onplay = function(payAudio){
                    _this.f_comienzaPruebaTyping(payAudio);
                };

                audioTyping[li_index].onpause = function(pauseAudio){
                    _this.f_pausaPruebaTyping(pauseAudio);
                };
                
                audioTyping[li_index].ontimeupdate = function(timeUpdate){
                    _this.f_startCounter(timeUpdate);
                };
                
                audioTyping[li_index].onended = function(endAudio) {
                    _this.f_endPruebaTyping(endAudio);
                };
            }
        }        
    },
    f_startCounter: function(e){
        lo_currentAudio = e.currentTarget;
        li_id_pregunta = $(lo_currentAudio).data("iq");
        li_segundosDuracion = parseInt(lo_currentAudio.currentTime);                
        $("#text_total_tiempo_test_"+li_id_pregunta).html(li_segundosDuracion+"<small>s</small>");
        
        ls_digitos = $("textarea[data-iq='"+li_id_pregunta+"']").val();
        li_totalDigitos = ls_digitos.length;
        $("#text_total_digitios_test_"+li_id_pregunta).html(li_totalDigitos);
    },
    f_pausaPruebaTyping: function(e){
        lo_currentAudio = e.currentTarget;
        li_id_pregunta = $(lo_currentAudio).data("iq");
        $("textarea[data-iq='"+li_id_pregunta+"']").prop("disabled", true);
    },
    f_endPruebaTyping: function(e){
        lo_currentAudio = e.currentTarget;
        li_id_pregunta = $(lo_currentAudio).data("iq");        
        setTimeout(function() {
            $("textarea[data-iq='"+li_id_pregunta+"']").prop("disabled", true);
        },10);
        
        var fechaCompleta = new Date();
        var ls_hora = f_agregaCero(fechaCompleta.getHours());
        var ls_minutos = f_agregaCero(fechaCompleta.getMinutes());
        var ls_segundo = f_agregaCero(fechaCompleta.getSeconds());
        
        ls_horaFinaliza = ls_hora+":"+ls_minutos+":"+ls_segundo;
        $("#text_finaliza_test_"+li_id_pregunta).html(ls_horaFinaliza);
        
        $($(lo_currentAudio).parent()).html('<div class="alert alert-success">Prueba de typing terminada</div> ');
    },
    f_comienzaPruebaTyping: function(e){
        lo_currentAudio = e.currentTarget;
        li_id_pregunta = $(lo_currentAudio).data("iq");        
        setTimeout(function() {
            $("textarea[data-iq='"+li_id_pregunta+"']").prop("disabled", false).focus();
        },10);
        
        var fechaCompleta = new Date();
        var ls_hora = f_agregaCero(fechaCompleta.getHours());
        var ls_minutos = f_agregaCero(fechaCompleta.getMinutes());
        var ls_segundo = f_agregaCero(fechaCompleta.getSeconds());
        
        ls_horaEmpieza = ls_hora+":"+ls_minutos+":"+ls_segundo;
        $("#text_inicia_test_"+li_id_pregunta).html(ls_horaEmpieza);                
    },
    f_finalizarProcesoSolicitud: function(e){
        var _this = this;
        var la_dataCollection = {};
        
        var la_infoGral = {};
        var la_infoGral = _this.f_validarInfoGral();
        if(la_infoGral < 0){
            return -1;
        }
        
        var la_cuestionarioGral = {};
        var la_cuestionarioGral = _this.f_validarCuestionario(".panel-nach-pregunta");
        if(la_cuestionarioGral < 0){
            return -1;
        }
        
        var la_cuestionarioOrtografia = {};
        var la_cuestionarioOrtografia = _this.f_validarCuestionario(".panel-nach-pregunta-ortografia");
        if(la_cuestionarioOrtografia < 0){
            return -1;
        }
        
        var la_cuestionarioTyping = {};
        var la_cuestionarioTyping = _this.f_validarCuestionario(".panel-nach-pregunta-typing");
        if(la_cuestionarioTyping < 0){
            return -1;
        }
        
        var la_cargaDos = {};
        var la_cargaDos = _this.f_validarCargaDocs();
        if(la_cargaDos < 0){
            return -1;
        }
        
        la_dataCollection = {
            info_general: la_infoGral
        }
        
        _this.model.finalizarProcesoSolicitudModel(la_dataCollection).done(function (response){
            if(response.return < 0){
                swal("¡Error!", "Ocurrió un error inesperado, favor de contactar a sistemas.", "error");
                return -1;
            }

            if(response.login){
                location.href = BASE_URL+'panel-principal';
            }else{
                swal("¡Atención!", response.mensaje, "error");
                return -1;
            }
        });
        return 1;
    },
    f_avanzarProceso: function(e){
        var _this = this;
        lo_currentItem = e.currentTarget;
        ls_currentStep = $(lo_currentItem).data("cs");
        ls_nextStep = $(lo_currentItem).data("ns");
        
        if(ls_currentStep === 'info-gral' && _this.f_validarInfoGral() < 0){
            return -1;
        }
        
        if(ls_currentStep === 'cuestionario' && _this.f_validarCuestionario(".panel-nach-pregunta") < 0){
           return -1;
        }
        
        if(ls_currentStep === 'prueba-ortografia' && _this.f_validarCuestionario(".panel-nach-pregunta-ortografia") < 0){
            return -1;
        }
        
        if(ls_currentStep === 'prueba-typing' && _this.f_validarCuestionario(".panel-nach-pregunta-typing") < 0){
            return -1;
        }
        
        $("a[data-contenido-tab='"+ls_currentStep+"']").parent().removeClass("active");
        $("#"+ls_currentStep).removeClass("active");
        
        $("a[data-contenido-tab='"+ls_nextStep+"']").parent().addClass("active");
        $("#"+ls_nextStep).addClass("active");                
    },
    f_validarCargaDocs: function(e){
        var _this = this;
        la_inputsFiles = $("#cargar-documentacion input");
        li_total_files = la_inputsFiles.length;
        
        if(li_total_files == 0){
            swal("¡Error!", "Ocurrió un error inesperado, favor de contacctar a sistemas", "error");
            return -1;
        }
        
        var form_data = new FormData();
        li_total_errores = 0;
        for(li_index = 0; li_index < li_total_files; li_index++){
            ls_pathFile = $(la_inputsFiles[li_index]).val();
            la_parentContent = $(la_inputsFiles[li_index]).parent();
            if(ls_pathFile.trim().length == 0){                
                $(la_parentContent).addClass("border-left-error").removeClass("border-left-success");
                li_total_errores++;
            }else{
                $(la_parentContent).removeClass("border-left-error").addClass("border-left-success");
                
                var file_data = $(la_inputsFiles[li_index]).prop('files')[0];                
                form_data.append('file', file_data);
            }
        }
        
        if(li_total_errores > 0){
            swal("Atención", "No ha cargado todos sus documentos, por favor, cargue los que están marcados con rojo.", "warning");
            return -1;
        }
        
        return {documentos: form_data};
    },
    f_cambioTabs: function(e){
        var _this = this;
        e.stopPropagation();
        lo_currentItem = e.currentTarget;
        
        la_childrens = $(lo_currentItem).children();
        lo_hrefChildren = la_childrens[0];
        ls_targetTab = $(lo_hrefChildren).data("contenido-tab");
        
        /*
         * Quitar activos
         */
        $("li.tab_control").removeClass("active");
        $("div.tab-pane").removeClass("active");
        $("li.tab_control > a").focusout();
                
        
        $(lo_currentItem).addClass("active");
        $("#"+ls_targetTab).addClass("active");
    },
    f_validarCuestionario: function(ls_class_name){
        var _this = this;
        la_preguntas = $(ls_class_name);
        li_total_preguntas = la_preguntas.length;
        li_index = 0;
        li_total_errores = 0;
        var la_respuestas = [];
        if(li_total_preguntas > 0){
            for(li_index = 0; li_index < li_total_preguntas; li_index++){
                var la_respuesta = {};
                li_tipo_pregunta = $(la_preguntas[li_index]).data("tq");
                /*
                 * 1: abierta (textarea)
                 * 2: radios
                 * 3: checkbox
                 */
                
                li_id_pregunta = $(la_preguntas[li_index]).data("iq");
                ls_respuesta = "";
                if(li_tipo_pregunta == 1){
                    ls_valor_texarea = $("textarea[data-iq='"+li_id_pregunta+"']").val();
                    if(ls_valor_texarea.trim().length == 0){
                        $(la_preguntas[li_index]).addClass("border-left-error").removeClass("border-left-success");
                        li_total_errores++;
                    }else{
                        $(la_preguntas[li_index]).removeClass("border-left-error").addClass("border-left-success");
                    }
                    
                    ls_respuesta = ls_valor_texarea;
                }
                
                if(li_tipo_pregunta == 2 || li_tipo_pregunta == 3){
                    if(!$("input[name='respuesta_"+li_id_pregunta+"']").is(":checked")){
                        $(la_preguntas[li_index]).addClass("border-left-error").removeClass("border-left-success");
                        li_total_errores++;
                    }else{
                        $(la_preguntas[li_index]).removeClass("border-left-error").addClass("border-left-success");
                        
                        if(li_tipo_pregunta == 2){
                            ls_respuesta = $("input[name='respuesta_"+li_id_pregunta+"']").val();
                        }
                        
                        if(li_tipo_pregunta == 3){                            
                            la_seleccionadas = $("input[data-iq='"+li_id_pregunta+"']:checked");
                            li_totalSeleccionados = la_seleccionadas.length;
                            if(li_totalSeleccionados > 0){
                                for(li_indice = 0; li_indice  < li_totalSeleccionados; li_indice++){
                                    ls_respuesta += $(la_seleccionadas[li_indice]).val()+",";
                                }
                            }
                        }
                    }
                }
                
                la_respuesta = {
                    id_pregunta: li_id_pregunta,
                    respuesta: ls_respuesta                    
                }
                
                la_respuestas.push(la_respuesta);
            }
            
            if(li_total_errores > 0){
                swal("Atención", "No ha contestado a todas las preguntas, por favor, corrija las que están marcadas con rojo.", "warning");
                return -1;
            }
        }
        return la_respuestas;
    },
    f_validarInfoGral: function(e){
        var _this = this;
        var la_dataInfoGral = {};
        ls_nombres = $(_this.defaults.nombres).val();        
        if(ls_nombres.trim().length == 0){
            $(_this.defaults.nombres).addClass("border-left-error").removeClass("border-left-success");
            swal("Atención", "Ingrese su nombre para continuar.", "warning");
            return -1;
        }
        $(_this.defaults.nombres).addClass("border-left-success").removeClass("border-left-error");
        
        ls_apellido_paterno = $(_this.defaults.apellido_paterno).val();
        if(ls_apellido_paterno.trim().length == 0){
            $(_this.defaults.apellido_paterno).addClass("border-left-error").removeClass("border-left-success");
            swal("Atención", "Ingrese su apellido paterno para continuar.", "warning");
            return -1;
        }
        $(_this.defaults.apellido_paterno).addClass("border-left-success").removeClass("border-left-error");
        
        
        ls_apellido_materno = $(_this.defaults.apellido_materno).val().trim();
        
        ls_rfc = $(_this.defaults.rfc).val();
        if(ls_rfc.trim().length == 0){
            $(_this.defaults.rfc).addClass("border-left-error").removeClass("border-left-success");
            swal("Atención", "Ingrese su RFC para continuar.", "warning");
            return -1;
        }
        $(_this.defaults.rfc).addClass("border-left-success").removeClass("border-left-error");
        
        ls_numero_telefono = $(_this.defaults.numero_telefono).val();
        if(ls_numero_telefono.trim().length == 0){
            $(_this.defaults.numero_telefono).addClass("border-left-error").removeClass("border-left-success");
            swal("Atención", "Ingrese su número telefónico para continuar.", "warning");
            return -1;
        }
        $(_this.defaults.numero_telefono).addClass("border-left-success").removeClass("border-left-error");
        
        ls_cargar_solicitud = $(_this.defaults.cargar_solicitud).val();
        if(ls_cargar_solicitud.trim().length == 0){
            swal("Atención", "No ha seleccionado su solicitud de empleo.", "warning");
            return -1;
        }
        
        var file_data = $(_this.defaults.cargar_solicitud).prop('files')[0];            
        var form_data = new FormData();                  
        form_data.append('file', file_data);
        
        la_dataInfoGral = {
            nombres: ls_nombres,
            apellido_paterno: ls_apellido_paterno,
            apellido_materno: ls_apellido_materno,
            rfc: ls_rfc,
            numero_telefono: ls_numero_telefono,
            cargar_solicitud: form_data
        }
        
        return la_dataInfoGral;
    }    
});

$(document).ready(function () {
    CandidatosPanel_view = new CandidatosPanel_view({model: new CandidatosPanel_model()});    
});