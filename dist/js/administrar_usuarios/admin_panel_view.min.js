
var AdminUsuario_view = Backbone.View.extend({

    el:'body',
    defaults:{
        content_page: "#content_page",
    },
    events:{
        'click .nuevoUsuario':'f_nuevoUsuario',
        'click .btnDeleteUsuario':'f_borrarUsuario',
        "click .btnGetUsuario":'f_getUsuario',
        'click #btnGuardarCambiosUsuario':'f_guardarCambiosUsuario',
        "click .btnAsignarDocs":"f_viewDocs",
        "click .asignarVacante":"f_asignarVacante",
        "click .btnGuardarDocumentos":"f_guardarDocs"
    },
    initialize: function(e){
        try {   

            $("#tablaUsuarios").DataTable();

        }catch(exception){
            console.log(exception);
        }
    },

    f_nuevoUsuario:function(e){
        var _this = this;
        la_data = {
            nombre: $(".txtNombre").val(),
            ap:     $(".txtAP").val(),
            am:     $(".txtAM").val(),
            rfc:    $(".txtrfc").val(),
            correo: $(".txtCorreo").val(),
            sexo:   $(".txtSexo").val(),
            tipo:   $(".txtTipo").val(),
            numero: $(".txtNumero").val()
        }

        if(la_data.nombre != "" && la_data.ap != "" && la_data.am != "" && la_data.rfc != "" && la_data.correo != "" && la_data.sexo != "0" && 
        la_data.tipo != "0" && la_data.numero!= ""){

            if(la_data.rfc.length > 10 && la_data.rfc.length == 13){
                la_data.rfc =  la_data.rfc.toUpperCase();

                _this.model.f_guardarNuevoUsuario(la_data).done(function(respose){
                    swal("Bien!","Usuario dado de alta correctamente","success");
                    window.setInterval(miFuncion, 3000,'Parametro 1', 'Parametro 2');
                });

            }else{
                swal("Verifica!","RFC No Valido","error");

            }
            
        }else{

            elementos = ["txtNombre","txtAP","txtAM","txtrfc","txtCorreo","txtNumero","txtSexo","txtTipo"];

                elementos.forEach(item=>{
                    valor = $("."+item).val();
                    if(valor == "" || valor == 0){
                        $("."+item).css({"border":"2px solid #f38585"});
                    }    
                });

                swal("Upps!!","Debe rellenar todos los campos","error");
        }

        function miFuncion(a,b) {
            location.reload();
        }
    },

    f_borrarUsuario:function(e){
        var _this = this;
        lo_current = e.currentTarget;

        var id_persona = parseInt($(lo_current).data('hash'));

        swal({   
            title: "Â¿Esta seguro?",   
            text: "Que desea, elimnar este usuario !!",   
            type: "warning",   
            showCancelButton: true,   
            confirmButtonColor: "#DD6B55",   
            confirmButtonText: "Confirmar",   
            closeOnConfirm: false 
        }, function(response){ 

            if(response) {
                _this.model.f_borrarUsuario(id_persona).done(function(respose){
                    if(respose.ok){
                        swal("Bien!!",respose.mensaje,"success");
                        location.href = BASE_URL+'admin-usuarios/ver-usuarios';
                    }else{
                        swal("Upps!","Fue imposible dar de baja, favor de verificar","error");
                    }
                });
            } else {
                swal("Cancelado correctamente");
            }

        });
    },
    f_guardarCambiosUsuario:function(e){

        var _this = this;
        lo_current = e.currentTarget;

        var id_persona = parseInt($(lo_current).data('hash'));
        
        la_data = {
            id_persona:id_persona,
            nombre: $(".editNombre"+id_persona).val(),
            ap:     $(".editAP"+id_persona).val(),
            am:     $(".editAM"+id_persona).val(),
            rfc:    $(".editRFC"+id_persona).val(),
            correo: $(".editCorreo"+id_persona).val(),
            sexo:   $(".editSexo"+id_persona).val(),
            tipo:   $(".editTipo"+id_persona).val(),
            numero: $(".editNumero"+id_persona).val()
        }

        _this.model.f_cambiosUsuario(la_data).done(function(respose){
            console.log(respose);
            if(respose.ok){
                swal('Bien','Datos actualizados correctamente','success');
                location.href = BASE_URL+'admin-usuarios/ver-usuarios';
            }else{
                swal('Upss','No fue posible actualizar los datos correctamente','error');
            }
        });

    },
    f_viewDocs:function(){
        var _this = this;
        _this.model.f_docs().done(function(response){
            $(_this.defaults.content_page).html(response.contenido);
        });
    },
    f_asignarVacante:function(e){
        
        var _this = this;
        lo_current = e.currentTarget;
        var id_persona = parseInt($(lo_current).data('hash'));

        la_data = {
            id_persona:id_persona,
            vacante : $(".txtvacante"+id_persona).val()
        }

        
        _this.model.f_asiganVacanteModel(la_data).done(function(response){

            if(response.asigna){
                swal('Aviso','Este candidato, ya tiene esta vacante','warning');
            }else{
                swal('Bien','Vacante asignada correctamente','success');
                setInterval(actualizar(),3000);
            }
        });

        function actualizar(){
            location.href = BASE_URL+'admin-usuarios/ver-usuarios';
        }
    },
    f_guardarDocs:function(e){
        var _this = this;
        lo_current = e.currentTarget;
        var id_persona = parseInt($(lo_current).data('hash'));
        
        la_data = {
            id_persona:id_persona,
            id_documento : $(".txtDoc"+id_persona).val()
        }

        _this.model.f_asiganDocs(la_data).done(function(response){
            console.log(response);
            if(response.asigna){
                swal('Bien','El candidato, ya le fue asignado este documento','warning');
            }else{
                swal('Bien','Vacante asignada correctamente','success');
            }
        });
    }

});

$(document).ready(function(){
    //Referencia al modelo
    AdminUsuario_view = new AdminUsuario_view({model: new Admin_usuarios_model()}); 
});