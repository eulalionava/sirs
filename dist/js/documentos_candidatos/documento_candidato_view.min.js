var VacantesCandidato_view = Backbone.View.extend({
    el: 'body',
    defaults: {
    }
    ,events:{
        "change .area_cargar_archivo": "f_activarAreaCargaDoc",
        "click .btn_cargar_documentos": "f_cargarDocumentos"
    },
    initialize: function(e){        
        try {
            var _this = this;
            _this.f_consultarDocumentosCandidato();
        }catch(exception){
            console.log(exception);
        }
    },
    f_consultarDocumentosCandidato(){
        var _this = this;
        var la_dataCollection = [];
        la_docs = $(".ddc");
        li_totalDosc = la_docs.length;
        
        if(li_totalDosc > 0){
            for(li_index = 0; li_index < li_totalDosc; li_index++){
                li_id_cliente = $(la_docs[li_index]).data("ic");
                li_id_documento = $(la_docs[li_index]).attr("id").replace("df_", "");
                la_dataCollection.push({"id_cliente": li_id_cliente, "id_documento": li_id_documento});
            }
        }
        
        _this.model.f_consultarDocumentosCandidatoModel(la_dataCollection).done(function (response){
            if(response.return < 0){
                swal("¡Error!", "Ocurrió un error inesperado, favor de contactar a sistemas.", "error");
                return -1;
            }
            
            li_total_docs = response.info_docs.length;
            if(li_total_docs > 0){
                for(li_index = 0; li_index < li_total_docs; li_index++){
                    ls_id_doc = response.info_docs[li_index].id_documento;
                    ls_hash_documento = response.info_docs[li_index].hash_documento;
                    
                    $("#df_"+ls_id_doc).attr("href", BASE_URL+"descargar-documento-candidato/"+ls_hash_documento);
                }
            }
        });
    },
    f_cargarDocumentos: function(e){
        var _this = this;
        lo_currentItem = e.currentTarget;
        ls_areaArchivos = "."+$(lo_currentItem).data("la");
        la_archivos = _this.f_validarCargaDocs(ls_areaArchivos);
        if(la_archivos < 0){
            return -1;
        }
                
        _this.model.f_cargarDocumentosModel(la_archivos).done(function (response){
            if(response.return < 0){
                swal("¡Atención!", response.mensaje, "error");
                return -1;
            }
            swal("¡Bien hecho!", "Se guardó correctamente el archivo seleccionado", "success");
            _this.f_consultarDocumentosCandidato();
        });
    },
    f_validarCargaDocs: function(arg_class){
        var _this = this;
        la_inputsFiles = $(arg_class+" input");
        li_total_files = la_inputsFiles.length;
        
        if(li_total_files == 0){
            swal("¡Error!", "Ocurrió un error inesperado, favor de contacctar a sistemas", "error");
            return -1;
        }
        
        var form_data = new FormData();
        li_total_errores = 0;
        for(li_index = 0; li_index < li_total_files; li_index++){
            ls_pathFile = $(la_inputsFiles[li_index]).val();
            la_parentContent = $(la_inputsFiles[li_index]).parent();
            if(ls_pathFile.trim().length == 0){                
                $(la_parentContent).addClass("border-left-error").removeClass("border-left-success");
                li_total_errores++;
            }else{
                $(la_parentContent).removeClass("border-left-error").addClass("border-left-success");
                
                li_id_cliente = $(la_inputsFiles[li_index]).data("ic");
                form_data.append('file[]', $(la_inputsFiles[li_index]).prop('files')[0]);
                form_data.append('id_documento[]', $(la_inputsFiles[li_index]).data("idc"));
                
                form_data.append('id_cliente', li_id_cliente);
            }
        }
        
        if(li_total_errores > 0){
            swal("Atención", "No ha cargado todos sus documentos, por favor, cargue los que están marcados con rojo.", "warning");
            return -1;
        }
        
        return form_data;
    },
    f_activarAreaCargaDoc: function(e){
        var _this = this;
        lo_currentItem = e.currentTarget;
        lo_currentChild = $(lo_currentItem).parent();
        ls_valorInput = $(lo_currentChild).val();
        
        if(ls_valorInput.trim().length > 0){
            $(lo_currentChild).addClass("border-left-error").removeClass("border-left-success");
        }else{
            $(lo_currentChild).removeClass("border-left-error").addClass("border-left-success");
        }
    }
});

$(document).ready(function () {
    VacantesCandidato_view = new VacantesCandidato_view({model: new VacantesCandidato_model()});    
});