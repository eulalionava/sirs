var Reclutamiento_view = Backbone.View.extend({
    el: 'body',
    defaults: {
        content_page: "#content_page",
    },
    events:{
        "change #selectEntrevistadores" :   "f_seleccionarEntrevistadores",
        "click #btnAltaEntrevistadores" :   "f_altaEntrevistadores",
        "click .btnBaja"                :   "f_bajaSeleccionador",
        "click .agendaManual"           :   "f_agendaManual",
        "click .agendaAuto"             :   "f_agendaAutomatico",
        "click #btnManual"              :   "f_verAgendaHorarios",
        "click #btnOK"                  :   "f_agendaHorarios",
        "click .btnGuardarCampania"     :   "f_guardarcampania",
        "click .btn-detalle"                : "f_detalleCandidato",
        "click .btn-validar-cuestionario"   : "f_validaCuestionarioCandidato",
        "click .btn-validar-documentos"     : "f_validardocumentosCandidato",
        "click .btnGuardarSegimiento":"f_guardarSegimiento"
 
        
    },
    initialize: function(e){
        try {   
        $("#tablaCandidatos").DataTable();
        entrevistadores     = Array();
        entrevistadores2    = Array();   
        horarios            = [];
        fechas              = [];
        tipoAgenda = 0;

        }catch(exception){
            console.log(exception);
        }
    },
    /**
     * 
     * Funcion: seleccionar 
     */
    f_seleccionarEntrevistadores:function(e){
        var id_entidad      = $("#selectEntrevistadores").val();
        var entidad_texto   = $('select[name="selectEntrevistadores"] option:selected').text();
        var lista           = $("#seleccionados");
        

        buscar = entrevistadores.includes(id_entidad);
        
        if(!buscar){

            if(id_entidad != 0){
                listado = "";
                entrevistadores.push(id_entidad);
                entrevistadores2.push(entidad_texto);
    
                listado += "<ul class='list-group'>";
                entrevistadores2.forEach(item =>listado+="<li class='list-group-item'>"+item+"</li>");
                listado += "</ul>";
            }
        }else{
            alert("Ya has elejido a este entrevistador");
        }

        lista.html(listado);

    },
    /**
     * 
     *Funcion: Alta general de los seleccionadores 
     */
    f_altaEntrevistadores:function(e){
        var _this = this;
        if(entrevistadores != "" ){
            _this.model.f_addEntrevistadores(entrevistadores).done( function(response){
                if(response.ok){

                    _this.f_getEntrevistadoresSeleccionados();
                    entrevistadores = "";
                    $("#seleccionados").html("");

                    swal('Bien',response.mensaje,'success');

                }else{
                    swal('Error',"No fue posible,dar de alta a tus entrevistadores",'error');
                }
            });
        }else{
            swal('Alerta','No tienes ningun entrevistador seleccionado','warning');
        }
    },
    /**
     * 
     * Dar de baja un seleccionador,solo cambiando el estatus 
     */
    f_bajaSeleccionador:function(e){

        var _this = this;

        var id = $('#tablaSeleccionadores').find('tbody tr td:eq(0)').html();

       _this.model.f_bajaSeleccionador(id).done( function(response){
            if(response.ok){
                _this.f_getEntrevistadoresSeleccionados();
            }
        });
    },
    /**
     * 
     * Funcion que solo regresa los seleccionadores dados de alta para entrvista
     */
    f_getEntrevistadoresSeleccionados:function(e){
        var _this = this;

        _this.model.f_entrevistadoreSeleccionados().done(function(res){
            $("#altasS").html(res.contenido);
        });

    },
    f_agendaAutomatico:function(e){   
        tipoAgenda = 2;
    },
    f_agendaManual:function(e){
        tipoAgenda = 1;
    },
    rangoDeDias:function(desde,hasta){

        var fecha1 = moment(desde);
        var fecha2 = moment(hasta);

        var dias = fecha2.diff(fecha1, 'days');
        return dias + 1;

    },
    calendarioDinamico:function(intervalo,inicio,fin,fecha_i,fecha_f){
        var _this = this;

        minimo = inicio * 60;
        maximo = fin * 60;


        fecha = new Date(fecha_i);
        dias = _this.rangoDeDias(fecha_i,fecha_f);

        html = "<table class='table table-bordered checks'>";
        html += "<thead>";
        html += "<th>Horarios</th>";
        for(var i = 1; i <= dias; i++ ){
            anio = fecha.getFullYear();
            mes  = fecha.getMonth() + 1;
            dia  = fecha.getDate() + i;

            fechaCompleta = anio+'-'+mes+'-'+dia;
            fechas.push(fechaCompleta);
            html += "<th>"+dia+"</th>";
        }
        
        html += "</thead>";
        html += "<tbody>";


        for(var i = minimo; i <= maximo; i=i+parseInt(intervalo)){
            horas = Math.floor( (i / 60) );
            minutos = (i % 60); 

            if(minutos != 0){
                hm = horas+':'+minutos;
                html += "<tr><td>"+hm+"</td>";
                for(var j=1;j<=dias;j++){
                    html += "<td><input type='checkbox' name='colorfavorito' value='"+fechas[j-1]+"' class='agendarFecha'></td>";
                }
                html += "</tr>"; 
            }else{
                hm = horas+':00';
                html += "<tr><td>"+hm+"</td>";
                for(var j=1;j<=dias;j++){
                    html += "<td><input type='checkbox' name='colorfavorito' value='"+fechas[j-1]+"' class='agendarFecha'></td>";
                }
                html += "</tr>"; 
            }
        }
        html+= "</tbody>";
        html+= "</table>";
        html+= "<input type='text' class='btn btn-success' value='Ok' id='btnOK' />";

        return html;

    },
    checkList:function(){
        var id_entrevistador = $(".entrevistador").val();
        if(id_entrevistador != 0){

            $(".checks").find("input[type=checkbox]").each(function(idx, ele){
                var checkbox = $(this);
                if(checkbox.is(":checked")){
                    fecha   = checkbox[0].value;
                    horario    = $(checkbox).parent("td").parent('tr')[0].cells[0].innerText;
                    horarios.push(
                        {   
                            id_entrevistador:id_entrevistador,
                            fecha:fecha,
                            hora:horario
                        }
                    );
                }
            });

            return horarios;

        }else{
            swal('¡¡Atención!!','Debes seleccionar un entrevistador','error');
        }
    },
    checkListAll:function(e){

        $(".checks").find("input[type=checkbox]").each(function(idx, ele){
            var checkbox = $(this);
            checkbox.prop('checked',true);
        });

    },
    f_verAgendaHorarios:function(e){ 
        var _this = this;

        var intervalo   = $("#intManual").val();
        var inicio      = $("#inicioManual").val();
        var fin         = $("#finManual").val();
        var fechaI      = $("#fechaInicioManual").val();
        var fechaF      = $("#fechaFinManual").val();

        elementos = ['intManual','fechaInicioManual','fechaFinManual'];

        if(intervalo != "" && fechaI != "" && fechaF != ""){

            html = _this.calendarioDinamico(intervalo,inicio,fin,fechaI,fechaF);
            $("#tablaDinamica").html(html);
            $(".verpanel").css("display","block");

            if(tipoAgenda == 2){
                _this.checkListAll();
            }

        }else{
            swal('¡¡ Atención!!','Debes rellenar completamente todos los campos','error');

        }
        


    },
    f_agendaHorarios:function(){

        var _this = this;
        var datos = _this.checkList();
        if(datos != null && datos != ""){
    
            _this.model.f_agregarEntrevistasPorSeleccionador(datos).done(function(res){
                console.log(res);
                if(res.ok){
                    $(".entrevistador option[value='"+res.id_entrevistador+"']").remove();
                    swal('Muy bien!!',res.mensaje,'success');
                }
            });

        }

    },
    f_detalleCandidato:function(e){
        var _this = this;
        lo_current = e.currentTarget;
        id_entidad = parseInt($(lo_current).data("hash"));

        console.log(id_entidad);
        _this.model.f_vacantesPorCandidato(id_entidad).done(function(response){
            $(_this.defaults.content_page).html(response.contenido);
        });
        
    },
    f_validaCuestionarioCandidato:function(e){
        var _this = this;
        lo_current = e.currentTarget;

        id_vacante = parseInt( $(lo_current).data('hash'));
        id_usuario = parseInt( $(lo_current).data('us'));
        cont = 1;
        _this.model.f_cuestionariosVacante(id_vacante,id_usuario).done(function(response){
            if(cont == 1){
                listado = "";
                color ="bg-success";
                cont+=1;
                if(response.cuestionarios != null){
                    listado+="<div class='row'>";
                    response.cuestionarios.forEach(item =>{
                        listado+="<div class='col-md-3'>"
                        listado+="<div class='panel panel-default'>";
                        listado+="<div class='panel-body' style='border: 1px solid #85c185;text-align: center;'>";
                        if(item.cantidad_intentos < item.intentos){
                            listado+="<i class='fa fa-times fa-5x'></i>";
                            listado+="<p>Faltante</p>";
                            color = "bg-danger";
                        }else{
                            listado+="<i class='fa fa-check fa-5x'></i>";
                            listado+="<p>Completado</p>";
                        }
                        listado+="</div>";
                        listado+="<div class='panel-footer "+color+"'>";
                        listado+="<p>"+item.titulo_cuestionario+"</p>";
                        listado+="</div>";
                        listado+="</div>";
                        listado+="</div>";
                    });
                    listado+="</div>";
                }else{
                    listado+="<div class='alert alert-danger'>Favor de asignar cuestionarios a esta vacante</div>";
                }
                $("#labelTitle").text("Cuestionarios");
                $("#info_model").html(listado);
                $("#modal").modal("show");
            }
        });

    },
    f_validardocumentosCandidato:function(e){
        var _this = this;
        lo_current = e.currentTarget;

        id_vacante = parseInt( $(lo_current).data('hash'));
        id_usuario = parseInt( $(lo_current).data('us'));

        cont = 1;
        _this.model.f_documentosVacante(id_vacante).done(function(response){
            if(cont == 1){
                listado = "";
                cont+=1;
                if(response.documentos != null){
                    listado+="<div class='row'>";
                    response.documentos.forEach(item =>{
                        listado+="<div class='col-md-3'>"
                        listado+="<div class='panel panel-default'>";
                        listado+="<div class='panel-body' style='border: 1px solid #85c185;'>";
                        listado+="<i class='fa fa-check fa-5x'></i>";
                        listado+="<p>Completado correctamente</p>";
                        listado+="</div>";
                        listado+="<div class='panel-footer bg-success'>";
                        listado+="<p>"+item.nombre_doc+"</p>";
                        listado+="</div>";
                        listado+="</div>";
                        listado+="</div>";
                    });
                    listado+="</div>";
                }else{
                    listado+="<div class='alert alert-danger'>Favor de asignar documentos para esta vacante</div>";
                }
                $("#labelTitle").text("Documentos");
                $("#info_model").html(listado);
                $("#modal").modal("show");
            }
        });
    },
    
    f_guardarSegimiento:function(e){
        var _this = this;
        lo_current = e.currentTarget;



        la_data = {
            id_persona_entidad  : parseInt($(lo_current).data('pe')),
            id_persona_vacante  : parseInt($(lo_current).data('hash')),
            id_usuario          : parseInt($(lo_current).data('us')),
            status              : $("#selecStatus").val()
        };

        _this.model.f_guardarSegimiento(la_data).done(function(res){
            if(res.ok){
                swal('Bien','Seguimiento dado de alta correctamente','success');
                window.setInterval(_this.actualizar,5000)
            }
        });
    },
    actualizar:function(){
        location.reload();
    },
    f_validacion_prueba:function(e){
        var _this = this;
        lo_current = e.currentTarget;

        console.log(e);
    },
    
    f_eliminarCliente:function(e){
        swal({   
            title: "¿Esta seguro?",   
            text: "Que desea, elimnar el registro de este cliente !!",   
            type: "warning",   
            showCancelButton: true,   
            confirmButtonColor: "#DD6B55",   
            confirmButtonText: "Confirmar",   
            closeOnConfirm: false 
        }, function(response){ 

            if(response) {
                swal("correcto","Cliente eliminado correctamente","success");
            } else {
                swal("Cancelado correctamente");
            }

        });
    },

    f_guardarCliente:function(e){
        var _this = this;

        data = {
            id          :   $(_this.defaults.idcliente).val(),
            cliente     :   $(_this.defaults.cliente).val(),
            descripcion :   $(_this.defaults.descripcion).val(),
            rfc         :   $(_this.defaults.rfc).val()
        }

        _this.model.f_guardarCliente(data).done( function(response){
            console.log(response);
            if(response.ok){
                swal("OK",response.message,"success");
                location.href = BASE_URL+'admon-clientes/catalogo-cliente/11';
            }else{
                swal("Atención!!","No se pudieron realizar los cambios,favor de verificar","error");
            }
        });
    },

    f_consultarCampania:function(e){
        var _this = this;

        var id = $('.tableCampania').find('td:eq(0)').html();
        var id_aplicativo = $('.tableCampania').find('td:eq(1)').html();

       _this.model.f_detalleCampania(id,id_aplicativo).done( function(response){
        $(_this.defaults.content_page).html(response.contenido);

       });

    },

    f_editarCampania:function(e){

        var _this = this;

        var id              = $('.tableCampania').find('td:eq(0)').html();
        var id_aplicativo   = $('.tableCampania').find('td:eq(1)').html();

       _this.model.f_editarCampania(id,id_aplicativo).done( function(response){
        $(_this.defaults.content_page).html(response.contenido);
        
       });

    },

    f_eliminarCampania:function(e){
        swal({   
            title: "¿Esta seguro?",   
            text: "Que desea, elimnar el registro de esta campaña !!",   
            type: "warning",   
            showCancelButton: true,   
            confirmButtonColor: "#DD6B55",   
            confirmButtonText: "Confirmar",   
            closeOnConfirm: false 
        }, function(response){ 

            if(response) {
                swal("correcto","Campaña eliminada correctamente","success");
            } else {
                swal("Cancelado correctamente");
            }

        });
    },
    f_guardarcampania:function(e){
        datos = {
            id          :   $("#txtIdCamp").val(),
            campania   :   $("#txtCampaniaCamp").val(),
            descripcion :   $("#txtDescripcionCamp").val()
        }

        this.model.f_guardarCampania(datos).done( function(response){
            console.log(response);
            if(response.ok){
                
                swal("OK",response.message,"success")
                location.href = BASE_URL+'admon-clientes/catalago-campania/12';

            }else{
                swal("Atención!!","No se pudieron realizar los cambios,favor de verificar","error");
            }
        });
    }

      


});

$(document).ready(function () {
    Reclutamiento_view = new Reclutamiento_view({model: new reclutamiento_model()});
    
});


function f_segimientoVacante(id_vacante){

        var model = new reclutamiento_model();
        
        model.f_segimientoVacanteModel(id_vacante).done(function(res){
            listado = "";
            if(res.segimiento != null){
                res.segimiento.forEach(item=>{
                    listado+="<div class='panel panel-default'>";
                    listado+="<div class='panel-heading'>";
                    listado+="<div class='row'>";
                    listado+="<div class='col-md-3'>";
                    listado+="<h4 class='panel-title'>"+item.nombres+' '+item.apellido_paterno+' '+item.apellido_materno+"</h4>";
                    listado+="</div>";
                    listado+="<div class='col-md-4'>";
                    listado+="<h4 class='panel-title'>"+item.vacante+"</h4>";
                    listado+="</div>";
                    listado+="<div class='col-md-2'>";
                    listado+="<select class='form-control' id='selecStatus'>";
                    listado+="<option value='0'>Incompleto</option>";
                    listado+="<option value='1'>Terminado</option>";
                    listado+="</select>";
                    listado+="</div>";
                    listado+="<div class='col-md-2'>";
                    listado+="<input type='button' class='btn btn-success btnGuardarSegimiento' value='Seguimiento' data-pe='"+item.id_persona_entidad+"' data-hash='"+item.id_persona_vacante+"' data-us='"+item.id_usuario+"'/>";
                    listado+="</div>";
                    listado+="</div>";
                    listado+="</div>";
                    listado+="</div>";
                })
            }else{
                listado+="<div class='alert alert-danger'>Favor de asignar documentos para esta vacante</div>";
            }
            $("#labelTitle").text("Seguimiento de vacante");
            $("#info_model").html(listado);
    
            $("#modal").modal("show");     
            
        });
}